<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <!-- CSP: Allow self, inline styles, data URIs, and script from unpkg.com -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://unpkg.com; style-src 'self' 'unsafe-inline'; font-src 'self' data:; img-src 'self' data:;">
    <title>P2P Web Chat</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar: DM List & User Panel -->
        <div class="sidebar">
            <div class="sidebar-header">
                <button id="initiate-new-chat-sidebar-button" class="button-primary" title="New Chat / Connect">+</button>
            </div>
            <div class="dm-list">
                <div class="dm-item active-dm" id="current-chat-dm-item" style="display:none;">
                    <span class="dm-item-avatar" id="dm-list-current-chat-avatar">P</span> <!-- Avatar will have initial -->
                    <span class="dm-item-name-tooltip" id="dm-list-current-chat-name-tooltip">Peer Name</span>
                    <span class="dm-item-status online"></span>
                </div>
            </div>
            <div class="user-panel" id="user-panel-clickable">
                <div class="user-info"> <!-- This is effectively the avatar container now -->
                    <span class="user-avatar" id="local-user-avatar-sidebar">U</span>
                </div>
                <div class="user-panel-tooltip" id="user-panel-details-tooltip">
                    <span class="user-name" id="tooltip-username-local">Username</span>
                    <div class="user-id-container">
                        <span class="user-id-sidebar-label">ID: </span><span id="tooltip-userid-local">Not Set</span>
                        <!-- Copy button will move to settings modal -->
                    </div>
                     <!-- Font size toggle will move to settings modal -->
                </div>
                <!-- Buttons are moved to settings modal -->
            </div>
        </div>

        <!-- Main Content: Chat Area / Setup Views -->
        <div class="main-content">
            <!-- Initial Setup View (Overlay) -->
            <div id="initial-setup-view" class="overlay-view active-overlay">
                <div class="setup-box card-overlay">
                    <h2>Welcome to P2P Chat!</h2>
                    <p>Please set your username to get started, or import an existing profile.</p>
                    <label for="display-name-input">Username:</label>
                    <input type="text" id="display-name-input" placeholder="Enter your username">
                    <button id="save-profile-button" class="button-primary">Save Profile & Get User ID</button>

                    <hr class="p2p-hr" style="margin: 20px 0;">

                    <label for="import-profile-file-input" class="button-secondary file-input-label full-width-button">Import Profile</label>
                    <input type="file" id="import-profile-file-input" class="hidden-file-input" accept=".json">
                </div>
            </div>

            <!-- P2P Connection Management View (Overlay) -->
            <div id="p2p-management-view" class="overlay-view">
                <div class="p2p-box card-overlay">
                    <h2 id="p2p-modal-title">Start or Respond to a Chat</h2>

                    <!-- Combined section for initiating or responding based on what user does -->
                    <div id="chat-initiation-section">
                        <h3>Start a New Chat</h3>
                        <label for="peer-id-input-modal">Peer's User ID:</label>
                        <input type="text" id="peer-id-input-modal" placeholder="Enter Peer's User ID">
                        <label for="initial-message-input-modal">Your first message (optional):</label>
                        <textarea id="initial-message-input-modal" rows="2" placeholder="Say hello..."></textarea>
                        <button id="send-initial-message-button-modal" class="button-primary">Send Message & Create Request</button>
                    </div>

                    <hr class="p2p-hr">

                    <div id="paste-request-section">
                        <h3>Process Received Chat Request</h3>
                        <label for="incoming-chat-package-input-modal">Paste Chat Request Data from Peer:</label>
                        <textarea id="incoming-chat-package-input-modal" rows="4" placeholder="Paste the entire request data your peer sent you..."></textarea>
                        <button id="process-incoming-package-button-modal" class="button-primary">Process Request & Respond</button>
                    </div>

                    <!-- This area is shown after initiating or processing an offer/package -->
                    <div id="signaling-exchange-area-modal" style="display: none;">
                        <h4>Signaling Data (Manual Copy/Paste)</h4>

                        <div id="outgoing-signal-div-modal"> <!-- For user to copy their Offer+Msg or just Answer -->
                            <label for="outgoing-signal-textarea-modal">Your Outgoing Data (Copy this ENTIRE block and send to peer):</label>
                            <textarea id="outgoing-signal-textarea-modal" rows="5" readonly placeholder="Your Offer or Answer data will appear here..."></textarea>
                        </div>

                        <div id="initiator-waits-for-answer-div-modal" style="display:none;"> <!-- Only for original initiator -->
                            <label for="incoming-answer-sdp-input-modal">Peer's Answer SDP (Paste Answer from Peer here):</label>
                            <textarea id="incoming-answer-sdp-input-modal" rows="5" placeholder="Paste peer's Answer SDP here..."></textarea>
                            <button id="submit-incoming-answer-button-modal" class="button-primary">Submit Peer's Answer</button>
                        </div>
                        <!-- For trickle:true - these elements would need to be added if used -->
                        <!--
                        <label for="local-ice-candidates-output">Your new ICE Candidates (send to peer as they appear):</label>
                        <textarea id="local-ice-candidates-output" rows="3" readonly placeholder="Your new ICE candidates for the peer..."></textarea>
                        <label for="remote-ice-candidate-input">Peer's ICE Candidate (paste from peer):</label>
                        <input type="text" id="remote-ice-candidate-input" placeholder="Paste one ICE candidate string from peer">
                        <button id="add-remote-ice-candidate-button" class="button-secondary">Add Peer's ICE Candidate</button>
                        -->
                    </div>
                    <button id="cancel-p2p-setup-button" class="button-secondary" style="margin-top: 20px;">Close</button>
                </div>
            </div>

            <!-- Chat View -->
            <div class="chat-view" id="chat-view-area" style="display: none;">
                <div class="chat-header">
                    <div class="chat-header-info">
                        <span class="chat-header-avatar"></span>
                        <span id="chat-partner-name-header">Chat with Peer</span>
                    </div>
                    <div class="chat-header-actions">
                        <button id="set-nickname-button" class="header-button" title="Set Nickname" style="display:none;">‚úèÔ∏è</button>
                        <button id="start-voice-call-button" class="header-button" title="Start Voice Call" style="display:none;">üìû</button>
                        <button id="export-chat-button" class="header-button" title="Export Chat History">üíæ</button>
                        <button id="disconnect-chat-button" class="header-button" title="Disconnect Chat">‚ùå</button>
                    </div>
                </div>
                <div class="messages-list" id="messages-area">
                    <!-- Messages will appear here -->
                </div>
                <div class="message-input-box">
                    <button id="attach-file-button" class="attach-button" title="Attach File">üìé</button>
                    <input type="file" id="media-file-input" class="hidden-file-input" accept="image/*,video/*">
                    <input type="text" id="message-input" placeholder="Type a message...">
                    <button id="send-message-button" class="send-button" title="Send Message">‚û¢</button>
                </div>
            </div>

            <!-- Fallback view when no chat is active and setup is complete -->
            <div class="no-chat-selected-view" id="no-chat-view" style="display: none;">
                 <h2>No Active Chat</h2>
                 <p>Click "New Chat / Connect" in the sidebar to start a new conversation or manage connections.</p>
            </div>

            <!-- Settings Modal View (Overlay) -->
            <div id="settings-modal-view" class="overlay-view"> <!-- Initially hidden -->
                <div class="settings-box card-overlay">
                    <div class="settings-header">
                        <h2>User Settings</h2>
                        <button id="close-settings-modal-button" class="icon-button modal-close-button" title="Close Settings">‚ùå</button>
                    </div>
                    <div class="settings-content">
                        <div class="settings-section">
                            <h3>User Profile</h3>
                            <div class="setting-item">
                                <label>Username:</label>
                                <span id="settings-username-display" class="settings-value-display"></span>
                            </div>
                            <div class="setting-item">
                                <label>User ID:</label>
                                <div class="user-id-container settings-id-container">
                                    <span id="settings-userid-display" class="settings-value-display"></span>
                                    <button id="settings-copy-userid-button" class="icon-button" title="Copy User ID">üìã</button>
                                </div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>Appearance</h3>
                            <div class="setting-item">
                                <!-- <label>Font Size:</label> -->
                                <button id="settings-font-size-toggle-button" class="button-secondary full-width-button">Font Size: Normal</button>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>Chat Data</h3>
                            <div class="setting-item">
                                <button id="settings-export-chat-button" class="button-secondary full-width-button">Export Chat History</button>
                                <!-- For selective export, a list/dropdown would go here -->
                            </div>
                            <div class="setting-item">
                                <label for="settings-import-chat-file-input" class="button-secondary file-input-label full-width-button">Import Chat History</label>
                                <input type="file" id="settings-import-chat-file-input" class="hidden-file-input" accept=".json">
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>Account</h3>
                            <div class="setting-item">
                                <button id="settings-export-profile-button" class="button-secondary full-width-button">Export Profile</button>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>Voice & Audio</h3>
                            <div class="setting-item">
                                <label for="audio-input-select">Microphone (Input Device):</label>
                                <select id="audio-input-select" class="settings-select">
                                    <option value="">Default Microphone</option>
                                    <!-- Devices will be populated by JS -->
                                </select>
                            </div>
                            <div class="setting-item">
                                <label for="audio-output-select">Speakers (Output Device):</label>
                                <select id="audio-output-select" class="settings-select">
                                    <option value="">Default Speakers</option>
                                    <!-- Devices will be populated by JS - Note: Output selection is tricky -->
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- End Main Content -->
    </div> <!-- End App Container -->

    <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
    <!-- Ensure renderer.js is loaded AFTER SimplePeer from CDN -->
    <script src="./renderer.js"></script>
</body>
</html>
